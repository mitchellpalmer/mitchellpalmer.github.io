---
title: "A Covid-19 Vulnerability Index"
description: |
  If Covid-19 gets into the community, which countries have the vaccinations and health system capacity to handle it
author:
  - name: Mitchell Palmer
    url: https://mitchellpalmer.nz
    affiliation: Yale-NUS College
categories:
  - New Zealand
  - COVID-19
date: 09-16-2021
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include=FALSE}
library(tidyverse)
library(ggthemes)
library(kableExtra)
library(rmarkdown)

knitr::opts_chunk$set(echo = FALSE)
```

One of the greatest dangers of Covid-19 is that it can overwhelm healthcare systems, thus degrading the standard of care recieved by all patients. Assuming an outbreak occurs, a country's vulnerability to such an outcome can be approximated as a function of three factors:

- How many vaccinations have been given
- How effective those vaccinations are (against hospitalisation or serious illness)
- How much capacity the country's healthcare system has

Ideally, a vulnerability index would include a variety of other factors -- especially the age distribution of the population, the number of people with natural immunity to Covid-19 already acquired and the ability of the healthcare system to scale at speed -- but such factors are difficult to summarise in single number avaliable for a large number of countries.

As such, this brief blog post limits itself to a much simpler, more tractable model. First, we consider $n$ different vaccines administered in a country ($c$) with a population ($p_c$), each with an effectiveness against hospitalization ($e_i$), a recommended number of doses for a full course (i.e., 2 for Pfizer and 1 for J&J) ($f_i$), and  a number of doses of the vaccine given ($d_i$). With those figures, we can create an 'efficacy-weighted vaccination rate' ($r_c$). This weighting accounts for the obvious fact that lower efficacy vaccines need higher coverage to reach equivalent protection.

$$
r_c = \frac{\sum^{n}_{i=0}e_i \frac{d_i}{f_i}}{p_c}
$$

When we combine that vaccination rate (or, in fact, $(1-r_c)$ to proxy for the number of cases likely to escape, given the vaccination rate and efficacy) with a suitable proxy for healthcare system capacity -- in this case, the number of hospital beds $b_c$ per head, we create a vulnerability metric $v_c$ which essentially proxies for how long/severe an outbreak would have to be, in the absence of non-pharmaceutical interventions like lockdowns, to overwhelm the health system.

$$
v_c = \frac{1-r_c}{\left(\frac{b_c}{p_c}\right)}
$$

## The Practical Stuff
The best source for COVID-19 data is [Our World in Data](https://ourworldindata.org/), which has an incredible collection of data on many aspects of the pandemic. Unfortunately, however, its by-manufacturer data is relatively scarce. Due to my particular interest in these four countries, I have manually added the latest data for Singapore (Pfizer/Moderna is assumed at 50% share each, together with 100% of non-government vaccines being Sinovac), Australia (sourced from the TGA safety reports), New Zealand (from the Ministry of Health), and the United Kingdom (from the MHRA safety data) to their dataset.

### Estimating efficacy-weighted vaccination rates
We start with [OWID's vaccine-by-manufacturer data](https://github.com/owid/covid-19-data/blob/master/public/data/vaccinations/vaccinations-by-manufacturer.csv) (as at 16 September 2021 11pm Singapore time) with the aforementioned countries' data added. Then we join that data with data on the efficacy of the various vaccines against hospitalization caused by the Delta variant from various sources (this data is reproduced at the end of the post). Where data for the delta variant is not avaliable, we adjust the efficacy rate down by 10% (not percentage points), which is the percentage which [one study](https://www.nejm.org/doi/full/10.1056/nejmoa2108891) found the Astra-Zeneca's efficacy fell by when confronted by Delta rather than other variants or the original disease. Population data is then taken from the World Bank.

```{r}
library(wbstats)
populations <- wb(indicator="SP.POP.TOTL", mrv=1)
hospital <- wb_data(indicator="SH.MED.BEDS.ZS", mrnev=1) %>%
  filter(date >= 2010)

vax_efficacy <- read_csv("efficacy.csv") %>%
  mutate(adj_efficacy = if_else(delta, efficacy, 0.9 * efficacy))

vax_by_manu <- read_csv("vaccinations-by-manufacturer.csv") %>%
  group_by(location, vaccine) %>%
  slice(which.max(date)) %>%
  left_join(vax_efficacy) %>%
  mutate(effective_doses = efficacy * (total_vaccinations/fullcourse),
         full_courses = total_vaccinations/fullcourse)

by_country <- vax_by_manu %>%
  group_by(location) %>%
  summarise(effective_doses = sum(effective_doses),
            full_courses = sum(full_courses)) %>%
  mutate(country=recode(location,
                        `Hong Kong`="Hong Kong SAR, China",
                        Czechia="Czech Republic",
                        Slovakia="Slovak Republic",
                        `South Korea`="Korea, Rep.", 
                        default=location)) %>%
  left_join(populations) %>%
  left_join(hospital, by="country") %>%
  select(country=location,
         iso=iso3c.x,
         effective_doses,
         full_courses,
         population=value,
         beds=`SH.MED.BEDS.ZS`) %>%
  mutate(effective_vax_rate = effective_doses/population,
         vax_rate=full_courses/population)

paged_table(by_country %>% arrange(desc(effective_vax_rate)) %>% select(country, effective_vax_rate, vax_rate))
```

```{r}
for_graph <- by_country %>% 
  filter(country %in% c("New Zealand",
                       "Australia",
                       "United States",
                       "United Kingdom",
                       "France",
                       "Germany",
                       "Singapore")) %>%
  select(country,`Efficacy-Adjusted`=effective_vax_rate, Standard=vax_rate) %>%
  pivot_longer(c(`Efficacy-Adjusted`, Standard), names_to="Rate")

ggplot(for_graph) +
  geom_col(aes(x=country, y=value, fill=Rate), position='dodge') +
  scale_y_continuous(name="Vaccination Rate", labels=scales::percent) + 
  scale_x_discrete(name='') +
  labs(title="Standard vs Efficacy-Adjusted Vaccination Rates",
       subtitle="Doses for 2-dose vaccines are divided by 2.",
       caption="Analysis/Graph: Mitchell Palmer\nData: OWID, various sources") +
  theme_classic() +
  theme(legend.position="bottom")

```


We now have a useful metric for how well-vaccinated a population is against the risk of hospitalization due to the delta variant. 

### Estimating vulnerability

Now, following from the formula above, we integrate the World Bank's data on the number of hospital beds avaliable per capita to come to a conclusion about the vulnerability of the health system to an outbreak.

```{r}
vulnerability <- by_country %>%
  mutate(vuln_indx = (1-effective_vax_rate)/(beds/1000)) %>%
  select(country, beds_per_1000=beds, effective_vax_rate, vuln_indx) %>%
  filter(!is.na(vuln_indx))

paged_table(vulnerability %>% arrange(desc(vuln_indx)))
```

```{r}
ggplot(vulnerability %>% filter(country %in% c("New Zealand",
                                               "Australia",
                                               "United States",
                                               "United Kingdom",
                                               "France",
                                               "Germany",
                                               "Singapore"))) +
  geom_col(aes(x=country, y=vuln_indx, fill=country)) +
  scale_y_continuous(name="Covid-19 Vulnerability Index") + 
  guides(fill=FALSE) +
  scale_fill_economist() +
  scale_x_discrete(name='') +
  labs(title="Health system vulnerability to Covid-19 outbreak",
       subtitle="Based on vaccination rates/efficacy and hospital beds per capita",
       caption="Analysis/Graph: Mitchell Palmer\nData: OWID, World Bank") +
  theme_classic()
```


Now, there are a variety of limitations to this data (notably that World Bank beds-per-capita data can be up to 10 years old [it isn't for most countries in this dataset though] and is based on capacity, not *spare* capacity at any given moment), but the broad conclusion should be deeply worrying for my New Zealand compatriots: With our current level of vaccination and the current capacity of our health care system, New Zealand would be the most vulnerable rich country for which data is avaliable were the Delta variant to enter the community. On my crude metric, we would be roughly 60% more vulnerable than Australia. This seemingly validates the Prime Minister's decision to move very quickly into lockdown given the most recent outbreak -- and offers some explanation for why NSW took longer to do so. Moreover, it emphasises why it is so important for New Zealand's vaccination programme to succeed, despite its incredibly slovenly start.

There is a variety of complicated modelling (for instance, using a susceptible-infected-recovered model to account for natural immunity and exponential spread) which could likely improve the specific applicability of this model to decision-making, but, as a starting point and an intuition-builder, I think it is useful. Please let me know if you have any thoughts on how I could improve it! (Source code is avaliable at [Github](https://github.com/mitchellpalmer/mitchellpalmer.github.io/blob/master/_posts/2021-09-16-covid-19-vulnerability-index/covid-19-vulnerability-index.Rmd))

### Vaccine Effectiveness Data
```{r}
kable(vax_efficacy)
```



